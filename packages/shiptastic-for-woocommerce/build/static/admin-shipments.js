(()=>{var e,n;window.shiptastic=window.shiptastic||{},window.shiptastic.admin=window.shiptastic.admin||{},e=jQuery,(n=window.shiptastic).admin.shipments={params:{},shipments:{},$wrapper:!1,needsSaving:!1,needsShipments:!0,needsReturns:!1,init:function(){var t=n.admin.shipments;t.params=wc_shiptastic_admin_shipments_params,t.$wrapper=e("#panel-order-shipments"),t.needsShipments=t.$wrapper.find("#order-shipment-add").is(":visible"),t.needsReturns=t.$wrapper.find("#order-return-shipment-add").is(":visible"),t.initShipments(),e(document).ajaxComplete(t.onAjaxComplete),e(document).on("click","#order-shipments-list .shipment-header",t.onToggleShipment).on("change","#order-shipments-list :input:visible",t.setNeedsSaving).on("click","#panel-order-shipments #order-shipment-add",t.onAddShipment).on("click","#panel-order-shipments .remove-shipment",t.onRemoveShipment).on("click","#panel-order-shipments button#order-shipments-save",t.onSave).on("click","#panel-order-shipments .notice-dismiss",t.onRemoveNotice),e(document).on("wc_shiptastic_admin_shipment_modal_after_submit_success","a#order-return-shipment-add",t.onAddReturnSuccess),e("#panel-order-shipments #order-return-shipment-add").wc_shiptastic_admin_shipment_modal(),e(document.body).on("init_tooltips",t.initTiptip),t.initTiptip()},onAjaxComplete:function(e,t,i){var s=n.admin.shipments;if(null!=t&&i.hasOwnProperty("data")){var r=i.data,a=!1;try{a=JSON.parse('{"'+r.replace(/&/g,'","').replace(/=/g,'":"')+'"}',(function(e,n){return""===e?n:decodeURIComponent(n)}))}catch(e){a=!1}if(a&&a.hasOwnProperty("action")){var p=a.action;"woocommerce_save_order_items"!==p&&"woocommerce_remove_order_item"!==p&&"woocommerce_add_order_item"!==p&&"woocommerce_delete_refund"!==p||s.syncItemQuantities()}}},syncItemQuantities:function(){var e=n.admin.shipments;e.block();var t={action:"woocommerce_stc_validate_shipment_item_quantities",active:e.getActiveShipmentId()};e.doAjax(t,e.onSyncSuccess)},onSyncSuccess:function(e){var t=n.admin.shipments;t.unblock(),t.initShipments(),t.initTiptip()},onSave:function(e){var t=n.admin.shipments;return e.preventDefault(),t.save(),!1},save:function(){var e=n.admin.shipments;e.block();var t={action:"woocommerce_stc_save_shipments",active:e.getActiveShipmentId()};e.doAjax(t,e.onSaveSuccess)},initShipment:function(t){var i=n.admin.shipments;i.shipments.hasOwnProperty(t)?i.shipments[t].refreshDom():i.shipments[t]=new e.shipmentsShipment(t)},onSaveSuccess:function(e){var t=n.admin.shipments;t.initShipments(),t.setNeedsSaving(!1),t.unblock(),t.initTiptip()},getActiveShipmentId:function(){var e=n.admin.shipments.$wrapper.find(".order-shipment.active");return e.length>0&&e.data("shipment")},block:function(){n.admin.shipments.$wrapper.block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},unblock:function(){n.admin.shipments.$wrapper.unblock()},getData:function(t){var i=n.admin.shipments,s={};return t=t||{},e.each(i.$wrapper.find(":input[name]").serializeArray(),(function(n,t){-1!==t.name.indexOf("[]")?(t.name=t.name.replace("[]",""),s[t.name]=e.makeArray(s[t.name]),s[t.name].push(t.value)):s[t.name]=t.value})),e.extend(s,t),s},refresh:function(t){var i=n.admin.shipments,s=i.getShipment(i.getActiveShipmentId());current_packaging_id=!1,s&&(current_packaging_id=s.getShipment().find(".shipment-packaging-select").val()),t.hasOwnProperty("order_needs_new_shipments")&&i.setNeedsShipments(t.order_needs_new_shipments),t.hasOwnProperty("order_needs_new_returns")&&i.setNeedsReturns(t.order_needs_new_returns);var r=t.hasOwnProperty("shipments")?t.shipments:{};e.each(i.getShipments(),(function(e,n){r.hasOwnProperty(e)&&(n.setIsEditable(r[e].is_editable),n.setNeedsItems(r[e].needs_items),n.setWeight(r[e].weight),n.setLength(r[e].length),n.setWidth(r[e].width),n.setHeight(r[e].height),n.setTotalWeight(r[e].total_weight),i.initShipment(e))})),(t.hasOwnProperty("needs_refresh")||t.hasOwnProperty("needs_packaging_refresh"))&&t.hasOwnProperty("shipment_id")&&(i.initShipment(t.shipment_id),t.hasOwnProperty("needs_packaging_refresh")&&(s=i.getShipment(i.getActiveShipmentId()))&&(new_packaging_id=s.getShipment().find(".shipment-packaging-select").val(),new_packaging_id!==current_packaging_id&&i.getShipment(t.shipment_id).refreshDimensions()))},doAjax:function(t,i,s){var r=n.admin.shipments,a=r.params.ajax_url,p=r.$wrapper,o=!0;p.find(".notice-wrapper").empty(),i=i||r.onAjaxSuccess,s=s||r.onAjaxError,t.hasOwnProperty("refresh_fragments")&&(o=t.refresh_fragments),t.hasOwnProperty("security")||(t.security=r.params.edit_shipments_nonce),t.hasOwnProperty("order_id")||(t.order_id=r.params.order_id),t=r.getData(t),e.ajax({type:"POST",url:a,data:t,success:function(n){n.success?(o&&n.fragments&&e.each(n.fragments,(function(n,t){e(n).replaceWith(t),e(n).unblock()})),i.apply(p,[n]),r.refresh(n),r.initTiptip()):(s.apply(p,[n]),r.unblock(),n.hasOwnProperty("message")?r.addNotice(n.message,"error"):n.hasOwnProperty("messages")&&e.each(n.messages,(function(e,n){r.addNotice(n,"error")})),r.initTiptip())},error:function(e){s.apply(p,[e]),r.unblock(),r.initTiptip()},dataType:"json"})},onAjaxError:function(e){},onAjaxSuccess:function(e){},onRemoveNotice:function(){e(this).parents(".notice").slideUp(150,(function(){e(this).remove()}))},addNotice:function(e,t){n.admin.shipments.$wrapper.find(".notice-wrapper").append('<div class="notice is-dismissible notice-'+t+'"><p>'+e+'</p><button type="button" class="notice-dismiss"></button></div>')},getParams:function(){return n.admin.shipments.params},onRemoveShipment:function(){var t=n.admin.shipments,i=e(this).parents(".order-shipment").data("shipment");return window.confirm(t.getParams().i18n_remove_shipment_notice)&&t.removeShipment(i),!1},removeShipment:function(e){var t=n.admin.shipments,i={action:"woocommerce_stc_remove_shipment",shipment_id:e};t.block(),t.doAjax(i,t.onRemoveShipmentSuccess,t.onRemoveShipmentError)},onRemoveShipmentSuccess:function(t){var i=n.admin.shipments,s=Array.isArray(t.shipment_id)?t.shipment_id:[t.shipment_id];e.each(s,(function(e,n){var t=i.$wrapper.find("#shipment-"+n);t.length>0&&(t.hasClass("active")?t.find(".shipment-content-wrapper").slideUp(300,(function(){t.removeClass("active"),t.remove(),i.initShipments()})):t.remove())})),i.initShipments(),i.unblock()},onRemoveShipmentError:function(e){n.admin.shipments.unblock()},onAddShipment:function(){return n.admin.shipments.addShipment(),!1},addShipment:function(){var e=n.admin.shipments;e.block(),e.doAjax({action:"woocommerce_stc_add_shipment"},e.onAddShipmentSuccess,e.onAddShipmentError)},onAddShipmentSuccess:function(e){var t=n.admin.shipments;t.$wrapper.find(".order-shipment.active").length>0?t.$wrapper.find(".order-shipment.active").find(".shipment-content-wrapper").slideUp(300,(function(){t.$wrapper.find(".order-shipment.active").removeClass("active"),t.appendNewShipment(e),t.initShipments(),t.initTiptip(),t.unblock()})):(t.appendNewShipment(e),t.initShipments(),t.initTiptip(),t.unblock())},appendNewShipment:function(e){var t=n.admin.shipments;"simple"===e.new_shipment_type&&t.$wrapper.find(".panel-order-return-title").length>0?t.$wrapper.find(".panel-order-return-title").before(e.new_shipment):t.$wrapper.find("#order-shipments-list").append(e.new_shipment)},onAddShipmentError:function(e){},onAddReturnSuccess:function(e,t){n.admin.shipments.onAddShipmentSuccess(t)},setNeedsSaving:function(t){var i=n.admin.shipments,s=i.getActiveShipmentId(),r=!!s&&i.getShipment(s).getShipment();"boolean"!=typeof t&&(t=!0),i.needsSaving=!0===t,i.needsSaving?i.$wrapper.find("#order-shipments-save").show():i.$wrapper.find("#order-shipments-save").hide(),r&&(i.needsSaving?i.disableCreateButtons(r):i.enableCreateButtons(r)),i.hideOrShowFooter(),e(document.body).trigger("woocommerce_shiptastic_needs_saving",[i.needsSaving,i.getActiveShipmentId()]),i.initTiptip()},disableCreateButtons:function(t){var i=n.admin.shipments,s=t.find(".column-shipment-documents a.wc-stc-shipment-action-button.create, .column-shipment-documents a.wc-stc-shipment-action-button.refresh");s.length>0&&(s.addClass("disabled button-disabled"),s.each((function(){e(this).data("org-title",e(this).prop("title")),e(this).prop("title",i.params.i18n_save_before_create)})))},enableCreateButtons:function(t){n.admin.shipments;var i=t.find(".column-shipment-documents a.wc-stc-shipment-action-button.create, .column-shipment-documents a.wc-stc-shipment-action-button.refresh");i.length>0&&(i.removeClass("disabled button-disabled"),i.each((function(){e(this).data("org-title")&&e(this).prop("title",e(this).data("org-title"))})))},setNeedsShipments:function(e){var t=n.admin.shipments;"boolean"!=typeof e&&(e=!0),t.needsShipments=!0===e,t.needsShipments?(t.$wrapper.addClass("needs-shipments"),t.$wrapper.find("#order-shipment-add").show()):(t.$wrapper.removeClass("needs-shipments"),t.$wrapper.find("#order-shipment-add").hide()),t.hideOrShowFooter()},hideOrShowReturnTitle:function(){var e=n.admin.shipments;0===e.$wrapper.find(".order-shipment.shipment-return").length?e.$wrapper.find(".panel-order-return-title").addClass("hide-default"):e.$wrapper.find(".panel-order-return-title").removeClass("hide-default")},setNeedsReturns:function(e){var t=n.admin.shipments;"boolean"!=typeof e&&(e=!0),t.needsReturns=!0===e,t.needsReturns?(t.$wrapper.addClass("needs-returns"),t.$wrapper.find("#order-return-shipment-add").show()):(t.$wrapper.removeClass("needs-returns"),t.$wrapper.find("#order-return-shipment-add").hide()),t.hideOrShowFooter()},hideOrShowFooter:function(){var e=n.admin.shipments;e.needsSaving||e.needsShipments||e.needsReturns?e.$wrapper.find(".panel-footer").slideDown(300):e.$wrapper.find(".panel-footer").slideUp(300)},onToggleShipment:function(){var t=n.admin.shipments,i=e(this).parents(".order-shipment:first"),s=i.hasClass("active");t.closeShipments(),s||i.find("> .shipment-content-wrapper").slideDown(300,(function(){i.addClass("active")}))},closeShipments:function(){var e=n.admin.shipments;e.$wrapper.find(".order-shipment.active .shipment-content-wrapper").slideUp(300,(function(){e.$wrapper.find(".order-shipment.active").removeClass("active")}))},initShipments:function(){var t=n.admin.shipments;t.$wrapper=e("#panel-order-shipments"),t.$wrapper.find(".order-shipment").each((function(){var n=e(this).data("shipment");t.initShipment(n)})),t.hideOrShowReturnTitle()},getShipments:function(){return n.admin.shipments.shipments},getShipment:function(e){var t=n.admin.shipments.getShipments();return!!t.hasOwnProperty(e)&&t[e]},initTiptip:function(){var t=n.admin.shipments;t.$wrapper.find(".woocommerce-help-tip").tipTip({attribute:"data-tip",fadeIn:50,fadeOut:50,delay:200}),t.$wrapper.find(".tip").tipTip({fadeIn:50,fadeOut:50,delay:200}),e(document.body).trigger("shipments_init_tooltips")}},e(document).ready((function(){n.admin.shipments.init()})),((window.wcShiptastic=window.wcShiptastic||{}).static=window.wcShiptastic.static||{})["admin-shipments"]={}})();