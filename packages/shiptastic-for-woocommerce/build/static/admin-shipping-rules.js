!function(i,e,t){i((function(){var n=i(".wc-shiptastic-shipping-rules-rows"),s=i(".wc-shiptastic-shipping-rules"),a=t.template("wc-shiptastic-shipping-rules-row"),r=t.template("wc-shiptastic-shipping-rules-condition-row"),o=t.template("wc-shiptastic-shipping-rules-packaging-info"),c={},d=Backbone.Model.extend({updateRules:function(i,e){0===Object.keys(i).length&&(i={});var t={...this.get("rules")};t[String(e)]=i,this.set("rules",t)},updateConditions:function(i,e,t){0===Object.keys(i).length&&(i={});const n="rule_"===String(t).substring(0,5)?t:"rule_"+String(t),s={...this.getRule(e,t)};var a={...this.get("rules")};s.conditions=i,a[String(e)][n]=s,this.set("rules",a)},getRulesByPackaging:function(i){var e={...this.get("rules")};return e.hasOwnProperty(String(i))?e[String(i)]:{}},getRule:function(i,e){const t=this.getRulesByPackaging(i),n="rule_"===String(e).substring(0,5)?e:"rule_"+String(e);return t.hasOwnProperty(n)?t[n]:{}},getConditionsByRuleId:function(i,e){const t=this.getRule(i,e);return t.hasOwnProperty("conditions")?t.conditions:{}}}),l=Backbone.View.extend({rowTemplate:a,conditionViews:{},packaging:"",initialize:function(){this.packaging=String(i(this.el).data("packaging")),this.conditionViews={},i(this.el).on("change",{view:this},this.updateModelOnChange)},block:function(){i(this.el).block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},unblock:function(){i(this.el).unblock()},getRules:function(){return this.model.getRulesByPackaging(this.packaging)},render:function(){var e=this.getRules(),t=this;this.$el.empty(),this.unblock(),_.size(e)&&i.each(e,(function(i,e){t.renderRow(e)}))},renderRow:function(i){var e=this;e.$el.append(e.rowTemplate(i));var t=e.$el.find('tr[data-id="'+i.rule_id+'"]'),n=new u({model:e.model,el:t.find(".wc-shiptastic-shipping-rules-condition-rows")[0]});n.ruleId=i.rule_id,n.packaging=e.packaging,n.parentView=e,n.render(),e.initRow(i)},initFields:function(e,t){i(document.body).trigger("wc-enhanced-select-init"),e.find("select").each((function(){var e=i(this).data("attribute");if(t[e]){var n=Array.isArray(t[e])?t[e]:Array(String(t[e])),s=i(this);i.each(n,(function(i,e){$isSelected=s.find('option[value="'+String(e)+'"]'),$isSelected.length>0&&$isSelected.prop("selected",!0)})),s.hasClass("enhanced")&&s.trigger("change")}})),e.find("input.decimal").on("change",{view:this},this.onChangeDecimal),e.find("input.wc_input_price").on("change",{view:this},this.onChangePrice),e.find("input.decimal, input.wc_input_price").trigger("change")},initRow:function(e){var t=this.$el.find('tr[data-id="'+e.rule_id+'"]'),n=t.parents("tbody");if(this.initFields(t,e),t.find(".shipping-rule-remove").on("click",{view:this},this.onDeleteRow),t.find(".shipping-rule-add").on("click",{view:this},this.onAddRow),n.find("tr.wc-shiptastic-shipping-rules-packaging-info").length<=0){n.prepend(o);var s=n.find("tr.wc-shiptastic-shipping-rules-packaging-info");s.find(".packaging-title").html(n.data("title")),n.data("help-tip")?s.find(".woocommerce-help-tip").attr("data-tip",n.data("help-tip")):s.find(".woocommerce-help-tip").remove(),n.data("edit-url")&&s.find(".packaging-title").attr("href",n.data("edit-url"))}i(document.body).trigger("init_tooltips")},onChangeDecimal:function(t){i(this).closest("tr");var n=i(this);n.val(n.val().replace(".",e.decimal_separator))},onChangePrice:function(t){i(this).closest("tr");var n=i(this);n.val(n.val().replace(".",e.price_decimal_separator))},onDeleteRow:function(e){var t=e.data.view,n=t.model,s=t.getRules(),a="rule_"+i(this).closest("tr").data("id");return s[a]&&(delete s[a],n.updateRules(s,t.packaging)),t.render(),t.$el.find("tr.shipping-rule:last").length>0&&t.$el.find("tr.shipping-rule:last").addClass("current"),!1},onAddRow:function(e){var t=e.data.view,n=t.model,s=t.getRules(),a=s["rule_"+i(this).closest("tr").data("id")],r=_.extend({},a,{rule_id:"new-"+_.size(s)+"-"+Date.now(),newRow:!0,conditions:{},costs:""}),o=0;return i.each(a.conditions,(function(i,e){var t="new-c-"+Date.now()+o;r.conditions["condition_"+t]=_.extend({},e,{condition_id:t,rule_id:r.rule_id,newRow:!0}),o++})),s["rule_"+r.rule_id]=r,n.updateRules(s,t.packaging),t.renderRow(r),t.$el.find('tr[data-id="'+r.rule_id+'"]').trigger("focus"),!1},updateModelOnChange:function(t){var n=t.data.view,s=n.model,a=i(t.target),r="rule_"+a.closest("tr").data("id"),o=a.data("attribute"),d=a.val(),l=n.getRules();if(a.parents(".wc-shiptastic-shipping-rules-condition-rows").length>0)return!1;if(!a.is(":visible"))return!1;if(a.is(":checkbox")?d=a.is(":checked")?d:"":d&&a.hasClass("decimal")?d=parseFloat(d.replace(e.decimal_separator,".")):d&&a.hasClass("wc_input_price")&&(d=parseFloat(d.replace(e.price_decimal_separator,"."))),!l[r]||String(l[r][o])!==String(d))if(l[r][o]=d,String(l[r].packaging)!==String(n.packaging)){var p=l[r].packaging,u=c[p],h=u.getRules();h[r]={...l[r]},delete l[r],s.updateRules(l,n.packaging),u.model.updateRules(h,p),n.render(),u.render()}else s.updateRules(l,n.packaging)}}),p=new d({rules:e.rules}),u=l.extend({rowTemplate:r,ruleId:0,packaging:"",parentView:!1,initialize:function(){i(this.el).on("change",{view:this},this.updateModelOnChange)},getRules:function(){return this.model.getConditionsByRuleId(this.packaging,this.ruleId)},render:function(){var e=this.getRules(),t=this;this.$el.empty(),_.size(e)&&i.each(e,(function(i,e){t.renderRow(e)}))},renderRow:function(i){var e=this;e.$el.append(e.rowTemplate(i)),e.initRow(i)},initRow:function(e){var t=this.$el.find('tr[data-condition="'+e.condition_id+'"]');t.parents("tbody"),this.initFields(t,e),0===t.index()&&t.find(".condition-remove").hide(),t.find(".shipping-rules-type-container").hide(),t.find(".conditions-column:not(.conditions-when,.conditions-actions)").hide(),t.find(".shipping-rules-condition-type").on("change",{view:this},this.onChangeRuleType),t.find(".shipping-rules-condition-type").trigger("change"),t.find(".condition-remove").on("click",{view:this},this.onDeleteRow),t.find(".condition-add").on("click",{view:this},this.onAddRow),i(document.body).trigger("init_tooltips")},onChangeRuleType:function(e){var t=i(this).closest("tr"),n=i(this).val(),s=e.data.view;t.find(".shipping-rules-condition-type-container").hide(),t.find(".conditions-column:not(.conditions-when,.conditions-actions)").hide(),t.find(".shipping-rules-condition-type-container-"+n).show(),t.find(".shipping-rules-condition-type-container-"+n+".shipping-rule-condition-type-operator :input").length>0?t.find(".shipping-rules-condition-type-container-"+n+".shipping-rule-condition-type-operator :input").trigger("change"):s.updateModel(t.data("condition"),"operator",""),t.find(".shipping-rules-condition-type-container-"+n+".shipping-rule-condition-type-operator :input").trigger("change"),t.find(".shipping-rules-condition-type-container-"+n).parents(".conditions-column").show()},updateModel:function(i,e,t){var n=this.model,s="condition_"+i,a=this.getRules();a[s]&&String(a[s][e])===String(t)||(a[s][e]=t,n.updateConditions(a,this.packaging,this.ruleId))},updateModelOnChange:function(t){var n=t.data.view,s=i(t.target),a=s.closest("tr").data("condition"),r=s.data("attribute"),o=s.val();if(!s.is(":visible"))return!1;s.is(":checkbox")?o=s.is(":checked")?o:"":o&&s.hasClass("decimal")?o=parseFloat(o.replace(e.decimal_separator,".")):o&&s.hasClass("wc_input_price")&&(o=parseFloat(o.replace(e.price_decimal_separator,"."))),n.updateModel(a,r,o)},onDeleteRow:function(e){var t=e.data.view,n=t.model,s=t.getRules(),a=i(this).closest("tr"),r="condition_"+a.data("condition");return s[r]&&0!==a.index()&&(delete s[r],n.updateConditions(s,t.packaging,t.ruleId)),t.render(),!1},onAddRow:function(e){var t=e.data.view,n=t.model,s=t.getRules(),a=s["condition_"+i(this).closest("tr").data("condition")],r=_.extend({},a,{condition_id:"new-c-"+_.size(s)+"-"+Date.now(),newRow:!0,costs:""});return-1!==i.inArray(r.type,["weight","total"])&&(r[r.type+"_from"]=r[r.type+"_to"],r[r.type+"_to"]=""),s["condition_"+r.condition_id]=r,n.updateConditions(s,t.packaging,t.ruleId),t.renderRow(r),!1}});n.each((function(){var e=new l({model:p,el:i(this)});e.render(),c[i(this).data("packaging")]=e,i(this).sortable({items:"tr",cursor:"move",axis:"y",handle:"td.sort",scrollSensitivity:40,helper:function(e,t){return t.children().each((function(){i(this).width(i(this).width())})),t.css("left","0"),t},start:function(i,e){e.item.css("background-color","#f6f6f6")},stop:function(i,e){e.item.removeAttr("style"),e.item.trigger("updateMoveButtons"),e.item.trigger("focus")}})})),i(document).on("change",".wc-shiptastic-shipping-rules-cb-all",(function(){var e=i(this).parents("table");i(this).is(":checked")?e.find("input.cb").prop("checked",!0):e.find("input.cb").prop("checked",!1)})),i(document).on("click",".wc-shiptastic-shipping-rule-add",(function(){var t=i(".new-shipping-packaging").val(),n=c[t],s=n.model.getRulesByPackaging(t),a=_.extend({},e.default_shipping_rule,{rule_id:"new-"+_.size(s)+"-"+Date.now(),packaging:t,newRow:!0}),r="new-c-"+Date.now(),o=a.conditions[0];return a.conditions={},a.conditions["condition_"+r]=_.extend({},o,{condition_id:r,rule_id:a.rule_id,newRow:!0}),s["rule_"+a.rule_id]=a,n.model.updateRules(s,t),c[t].renderRow(a),c[t].$el.find('tr[data-id="'+a.rule_id+'"]').trigger("focus"),!1})),i(document).on("click",".wc-shiptastic-shipping-rule-remove",(function(){var e=p.get("rules"),t=i(this),n=t.parents("table"),s=[];return n.find("input.cb:checked").each((function(){var t="rule_"+i(this).val(),n=i(this).parents("tr").find(".shipping-packaging").val();s.includes(n)||s.push(n),delete e[n][t]})),p.set("rules",e),s.forEach((function(i,e){c[i].render()})),t.addClass("disabled"),n.find(".wc-shiptastic-shipping-rules-cb-all").prop("checked",!1),!1})),i(document).on("keydown",(function(e){var t=s.find("tr.current"),n=i(".wc-shiptastic-shipping-rules.has-focus");if(0!==t.length||0!==n.length){var a=e.metaKey||e.ctrlKey;return!a||"d"!==e.key&&"-"!==e.key?t&&a&&"+"===e.key?(t.find(".shipping-rule-add").trigger("click"),e.preventDefault(),e.stopPropagation(),!1):n&&a&&"a"===e.key?(n.find(".wc-shiptastic-shipping-rules-cb-all").prop("checked",!n.find(".wc-shiptastic-shipping-rules-cb-all").is(":checked")),n.find(".wc-shiptastic-shipping-rules-cb-all").trigger("change"),e.preventDefault(),e.stopPropagation(),!1):void 0:($selected=s.find("input.cb:checked"),$selected.length>0?s.find(".wc-shiptastic-shipping-rule-remove").trigger("click"):t&&t.find(".shipping-rule-remove").trigger("click"),e.preventDefault(),e.stopPropagation(),!1)}})),i(document).on("change",".wc-shiptastic-shipping-rules-rows input.cb, .wc-shiptastic-shipping-rules-cb-all",(function(){$selected=i(this).parents("table").find("input.cb:checked"),$selected.length>0?s.find(".wc-shiptastic-shipping-rule-remove").removeClass("disabled"):s.find(".wc-shiptastic-shipping-rule-remove").addClass("disabled")})),i(document).on("mouseup",(function(e){var t=i("table.wc-shiptastic-shipping-rules");t.is(e.target)||0!==t.has(e.target).length?t.addClass("has-focus"):(t.removeClass("has-focus"),t.find("tr").removeClass("current"))})),i(document).on("click",".wc-shiptastic-shipping-rules tbody, .wc-shiptastic-shipping-rules input",(function(){i(this).trigger("focus")})),i(document).on("focus click",".wc-shiptastic-shipping-rules input, .wc-shiptastic-shipping-rules tr",(function(e){i(this).parents("table").find("tr").removeClass("current"),i(this).closest("tr.shipping-rule").addClass("current")}))}))}(jQuery,wc_shiptastic_admin_shipping_rules_params,wp,ajaxurl),((window.wcShiptastic=window.wcShiptastic||{}).static=window.wcShiptastic.static||{})["admin-shipping-rules"]={};